name: Verify HUMEAN ledger

on:
  push:
    paths:
      - "attestation/**"
      - "scripts/verify_ledger.ps1"
      - ".github/workflows/verify-ledger.yml"
  workflow_dispatch:

jobs:
  verify-ledger:
    runs-on: [self-hosted, windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show directory structure
        shell: pwsh
        run: |
          Write-Host "üìÅ Structure du repo HUMEAN :"
          Get-ChildItem -Recurse | Select-Object FullName | Format-Table -AutoSize

      - name: Verify ledger integrity
        shell: pwsh
        run: |
          Write-Host "üîç V√©rification de l'int√©grit√© du ledger HUMEAN..."
          if (Test-Path "./scripts/verify_ledger.ps1") {
              ./scripts/verify_ledger.ps1
          } else {
              Write-Host "‚ùå Script verify_ledger.ps1 introuvable"
              # Fallback: v√©rification basique des fichiers
              $ledgerFiles = @("log/ledger.jsonl", "log/ledger_signed.jsonl")
              foreach ($file in $ledgerFiles) {
                  if (Test-Path $file) {
                      $content = Get-Content $file -Raw
                      Write-Host "‚úÖ $file existe ($($content.Length) caract√®res)"
                  } else {
                      Write-Host "‚ùå $file manquant"
                  }
              }
          }

      - name: Upload verification report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ledger-verification-${{ github.run_id }}
          path: |
            log/ledger.jsonl
            log/ledger_signed.jsonl
