name: HUMEAN - Monitoring Triple Provider

on:
  workflow_dispatch:
  push:
    paths: [".github/workflows/humean-monitoring.yml"]
  schedule:
    - cron: '*/15 * * * *'  # Toutes les 15 minutes

jobs:
  provider-healthcheck:
    runs-on: [self-hosted, windows]
    strategy:
      matrix:
        provider: [openai, deepseek, grok]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test ${{ matrix.provider }} API
        shell: pwsh
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          # CONCRET - uniquement ce qui marche maintenant
          $provider = "${{ matrix.provider }}"
          $startTime = Get-Date
          $result = @{
              provider = $provider
              timestamp = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
              status = "unknown"
              response_ms = 0
              error = $null
          }

          try {
              # OPENAI - endpoint r√©el, mod√®le r√©el
              if ($provider -eq "openai") {
                  $body = @{
                      model = "gpt-3.5-turbo"
                      messages = @(@{role="user"; content="R√©ponds OK"})
                      max_tokens = 10
                  } | ConvertTo-Json
                  
                  $response = Invoke-RestMethod -Uri "https://api.openai.com/v1/chat/completions" `
                      -Method Post `
                      -Headers @{ 
                          "Authorization" = "Bearer $env:OPENAI_API_KEY";
                          "Content-Type" = "application/json" 
                      } `
                      -Body $body `
                      -TimeoutSec 10
                  
                  $result.status = "success"
              }

              # DEEPSEEK - endpoint r√©el, mod√®le r√©el  
              elseif ($provider -eq "deepseek") {
                  $body = @{
                      model = "deepseek-chat"
                      messages = @(@{role="user"; content="R√©ponds OK"})
                      max_tokens = 10
                  } | ConvertTo-Json
                  
                  $response = Invoke-RestMethod -Uri "https://api.deepseek.com/chat/completions" `
                      -Method Post `
                      -Headers @{
                          "Authorization" = "Bearer $env:DEEPSEEK_API_KEY";
                          "Content-Type" = "application/json"
                      } `
                      -Body $body `
                      -TimeoutSec 10
                  
                  $result.status = "success"
              }

              # GROK - endpoint r√©el, mod√®le r√©el
              elseif ($provider -eq "grok") {
                  $body = @{
                      model = "grok-beta"
                      messages = @(@{role="user"; content="R√©ponds OK"})
                      max_tokens = 10
                  } | ConvertTo-Json
                  
                  $response = Invoke-RestMethod -Uri "https://api.x.ai/v1/chat/completions" `
                      -Method Post `
                      -Headers @{
                          "Authorization" = "Bearer $env:GROK_API_KEY";
                          "Content-Type" = "application/json"
                      } `
                      -Body $body `
                      -TimeoutSec 10
                  
                  $result.status = "success"
              }

          } catch {
              # Gestion CONCR√àTE des erreurs
              $result.status = "error"
              $result.error = $_.Exception.Message
          }

          # Calcul temps de r√©ponse R√âEL
          $result.response_ms = [math]::Round((Get-Date - $startTime).TotalMilliseconds, 2)

          # Export CONCRET des donn√©es
          $result | ConvertTo-Json | Out-File "status_$provider.json"
          Write-Host "‚úÖ $provider : $($result.status) ($($result.response_ms)ms)"

      - name: Upload Status File
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ matrix.provider }}
          path: status_${{ matrix.provider }}.json

  generate-report:
    runs-on: [self-hosted, windows]
    needs: provider-healthcheck
    steps:
      - name: Download Status Files
        uses: actions/download-artifact@v4
        with:
          path: ./status_files

      - name: Create Concrete Report
        shell: pwsh
        run: |
          # Rapport CONCRET - aucun concept quantique
          $report = @{
              generated_at = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
              workflow_run = "${{ github.run_id }}"
              providers = @()
          }

          Get-ChildItem "./status_files" -Filter "status_*.json" | ForEach-Object {
              $data = Get-Content $_.FullName | ConvertFrom-Json
              $report.providers += $data
          }

          # Calculs CONCRETS
          $successCount = ($report.providers | Where-Object { $_.status -eq "success" }).Count
          $totalCount = $report.providers.Count
          
          $report.summary = @{
              total_providers = $totalCount
              successful = $successCount
              health_percentage = if ($totalCount -gt 0) { [math]::Round(($successCount / $totalCount) * 100, 2) } else { 0 }
              average_response_ms = [math]::Round(($report.providers | Measure-Object -Property response_ms -Average).Average, 2)
          }

          # Export CONCRET
          $report | ConvertTo-Json -Depth 3 | Out-File "humean_status_report.json"
          Write-Host "üìä Rapport HUMEAN g√©n√©r√© : $($report.summary.health_percentage)% de sant√©"

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: humean-final-report
          path: humean_status_report.json
