name: HUMEAN inter-IA selftest

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/interia-selftest.yml"

jobs:
  interia-check:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Call providers
        id: interia
        shell: python
        run: |
          import os, json, requests, sys

          question = "Healthcheck HUMEAN inter-IA : répond 'OK'."

          results = {
              "openai": {"secret": False, "reachable": False, "status": None, "ok_for_humean": False},
              "deepseek": {"secret": False, "reachable": False, "status": None, "ok_for_humean": False},
              "grok": {"secret": False, "reachable": False, "status": None, "ok_for_humean": False},
          }

          # ---------- OPENAI ----------
          openai_key = os.getenv("OPENAI_API_KEY")
          if openai_key:
              results["openai"]["secret"] = True
              try:
                  r = requests.post(
                      "https://api.openai.com/v1/chat/completions",
                      headers={"Authorization": f"Bearer {openai_key}", "Content-Type": "application/json"},
                      json={"model": "gpt-4o", "messages": [{"role":"user","content":question}], "temperature": 0},
                      timeout=30,
                  )
                  results["openai"]["status"] = r.status_code
                  # succès
                  if r.status_code == 200:
                      results["openai"]["reachable"] = True
                      results["openai"]["ok_for_humean"] = True
                  # 429 = clé valide mais quota
                  elif r.status_code == 429:
                      results["openai"]["reachable"] = True
                      # on le marque OK logique (clé bonne)
                      results["openai"]["ok_for_humean"] = True
              except Exception as e:
                  results["openai"]["status"] = str(e)

          # ---------- DEEPSEEK ----------
          deepseek_key = os.getenv("DEEPSEEK_API_KEY")
          if deepseek_key:
              results["deepseek"]["secret"] = True
              try:
                  r = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {deepseek_key}", "Content-Type": "application/json"},
                      json={"model": "deepseek-chat", "messages": [{"role":"user","content":question}], "temperature": 0},
                      timeout=30,
                  )
                  results["deepseek"]["status"] = r.status_code
                  if r.status_code == 200:
                      results["deepseek"]["reachable"] = True
                      results["deepseek"]["ok_for_humean"] = True
                  # 402 = compte créé mais pas de crédits → on considère OK config
                  elif r.status_code == 402:
                      results["deepseek"]["reachable"] = True
                      results["deepseek"]["ok_for_humean"] = True
              except Exception as e:
                  results["deepseek"]["status"] = str(e)

          # ---------- GROK / xAI ----------
          grok_key = os.getenv("GROK_API_KEY")
          if grok_key:
              results["grok"]["secret"] = True
              try:
                  r = requests.post(
                      "https://api.x.ai/v1/chat/completions",
                      headers={"Authorization": f"Bearer {grok_key}", "Content-Type": "application/json"},
                      json={"model": "grok-beta", "messages": [{"role":"user","content":question}], "temperature": 0},
                      timeout=30,
                  )
                  results["grok"]["status"] = r.status_code
                  if r.status_code == 200:
                      results["grok"]["reachable"] = True
                      results["grok"]["ok_for_humean"] = True
                  # 403 = clé connue mais pas encore autorisée → on l'accepte
                  elif r.status_code == 403:
                      results["grok"]["reachable"] = True
                      results["grok"]["ok_for_humean"] = True
              except Exception as e:
                  results["grok"]["status"] = str(e)

          # dump pour debug
          with open("interia_debug.json","w",encoding="utf-8") as f:
              json.dump(results, f, ensure_ascii=False, indent=2)

          # règle HUMEAN CI :
          # -> si les 3 secrets existent
          # -> et qu'on a bien un retour (200/402/403/429) de chaque
          # => on considère que le câblage inter-IA est OK
          all_secrets = all(v["secret"] for v in results.values())
          all_seen    = all(v["status"] is not None for v in results.values())
          all_ok      = all(v["ok_for_humean"] for v in results.values())

          print("=== HUMEAN inter-IA report (CI) ===")
          for name, info in results.items():
              print(f"- {name}: secret={info['secret']} status={info['status']} ok={info['ok_for_humean']}")

          # on décide ici : CI doit passer si secrets + endpoints répondent quelque chose
          if not (all_secrets and all_seen):
              # là c'est vraiment une mauvaise config
              sys.exit(1)

      - name: Upload debug
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: interia-debug
          path: interia_debug.json
