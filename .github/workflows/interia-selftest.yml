name: HUMEAN inter-IA selftest

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/interia-selftest.yml"

jobs:
  interia-check:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests

      - name: Call 3 IA directly
        id: interia
        shell: python
        run: |
          import os, sys, json, requests, traceback

          question = "Healthcheck HUMEAN inter-IA : répond 'OK'."
          results = {}
          detail = {}
          ok_count = 0

          def log_err(name, err):
              print(f"{name} ERROR:", err)
              detail[f"{name}_error"] = str(err)

          # 1) OpenAI
          openai_key = os.getenv("OPENAI_API_KEY")
          if openai_key:
              try:
                  r = requests.post(
                      "https://api.openai.com/v1/chat/completions",
                      headers={"Authorization": f"Bearer {openai_key}", "Content-Type": "application/json"},
                      json={
                          "model": "gpt-4o",
                          "messages": [{"role": "user", "content": question}],
                          "temperature": 0
                      },
                      timeout=30
                  )
                  r.raise_for_status()
                  results["openai"] = True
                  ok_count += 1
                  detail["openai"] = r.json()
              except Exception as e:
                  results["openai"] = False
                  log_err("openai", e)
          else:
              results["openai"] = False
              log_err("openai", "missing secret")

          # 2) DeepSeek
          deepseek_key = os.getenv("DEEPSEEK_API_KEY")
          if deepseek_key:
              try:
                  r = requests.post(
                      "https://api.deepseek.com/chat/completions",
                      headers={"Authorization": f"Bearer {deepseek_key}", "Content-Type": "application/json"},
                      json={
                          "model": "deepseek-chat",
                          "messages": [{"role": "user", "content": question}],
                          "temperature": 0
                      },
                      timeout=30
                  )
                  r.raise_for_status()
                  results["deepseek"] = True
                  ok_count += 1
                  detail["deepseek"] = r.json()
              except Exception as e:
                  results["deepseek"] = False
                  log_err("deepseek", e)
          else:
              results["deepseek"] = False
              log_err("deepseek", "missing secret")

          # 3) Grok / xAI
          grok_key = os.getenv("GROK_API_KEY")
          if grok_key:
              try:
                  r = requests.post(
                      "https://api.x.ai/v1/chat/completions",
                      headers={"Authorization": f"Bearer {grok_key}", "Content-Type": "application/json"},
                      json={
                          "model": "grok-beta",
                          "messages": [{"role": "user", "content": question}],
                          "temperature": 0
                      },
                      timeout=30
                  )
                  r.raise_for_status()
                  results["grok"] = True
                  ok_count += 1
                  detail["grok"] = r.json()
              except Exception as e:
                  results["grok"] = False
                  log_err("grok", e)
          else:
              results["grok"] = False
              log_err("grok", "missing secret")

          print("=== HUMEAN inter-IA status ===")
          for name, status in results.items():
              if status:
                  print(f"[OK] {name} a répondu")
              else:
                  print(f"[KO] {name} n'a pas répondu")

          # on écrit le debug quoi qu'il arrive
          with open("interia_debug.json", "w", encoding="utf-8") as f:
              json.dump(
                  {
                      "results": results,
                      "detail": detail
                  },
                  f,
                  ensure_ascii=False,
                  indent=2
              )

          # politique HUMEAN : au moins 2 IA sur 3
          if ok_count < 2:
              sys.exit(1)

      - name: Upload debug
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: interia-debug
          path: interia_debug.json
